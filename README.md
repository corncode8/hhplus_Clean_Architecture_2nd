# hhplus_tdd_2st_Clean_Architecture

### API
- POST /reservation : 특강 신청 API
- GET /check/{id} : 특강 신청 여부 조회 API

### 요구사항
- `특강 신청 서비스`를 구현해 봅니다.
- 선착순으로 제공되는 특강을 신청하는 API 를 작성합니다.
- 특강은 4월 20일 토요일 1시 에 열리며, 선착순 30명만 신청 가능합니다.
- 이미 신청자가 30명이 초과되면 이후 신청자는 요청을 실패합니다.
- 다수의 인스턴스로 어플리케이션이 동작하더라도 기능에 문제가 없도록 작성하도록 합니다.
- 동시성 이슈를 고려하여 구현합니다.

### 특강 신청 API
- 유저 조회
  - 없다면 오류 발생
- 강의 조회
  - 없다면 오류 발생
- 4월 20일 토요일 1시 시간 검증
- 신청한 유저인지 검증
- 30명이 초과되었는지 검증
- return Status

### 특강 신청 여부 조회 API
- 유저 조회
  - 없다면 오류 발생
- return User Status

### 테스트
#### 단위테스트
- Mock 을 이용한 단위테스트
- Domain, Service, Component Layer Test
#### 통합 테스트
- IntegrationTest (동시성 테스트)

### 동시성 처리 방법
1. DB 리소스를 쓰는 방법 (가장 비싼 자원)
- 낙관적 락(Optimistic Lock)
  - 자원에 락을 걸지 않고, 동시성 문제가 발생하면 그때 처리 한다.
  - 낙관적 락은 수정할 때 수정했다고 명시하여 다른 트랜잭션이 동일한 조건으로 값을 수정할 수 없게 하는 것이다.
  - 낙관적 락은 version과 같은 별도의 컬럼을 추가하여 충돌 발생을 막는다.
    
- 비관적 락(Pessimistic Lock) -> 이번 프로젝트에서 사용
  - 비관적 락은 Repeatable Read 또는 Serializable 정도의 격리성 수준을 제공한다.
  - 트랜잭션이 시작될 때 Shared Lock 또는 Exclusive Lock을 걸고 시작한다.
  - 공유락 (Shared Lock) : Read Lock이라고도 불리는 공유락은 트랜잭션이 읽기를 할 때 사용하는 락이며, 데이터를 읽기만하기 때문에 같은 공유락끼리는 동시에 접근이 가능하지만, write 작업은 막는다.
  - 배타락 (Exclusive Lock) : Write Lock이라고도 불리며, 데이터를 변경할 때 사용하는 락이다. 트랜잭션이 완료될 때까지 유지되며, 배타락이 끝나기 전까지 read/write를 모두 막는다.
  - 트랜젝션 처리량은 떨어지지만 비즈니스적인 유저 세션 개념에서는 처리량이 늘어남.

- DB 레벨에서 락을 사용해야 하는 이유
    - 여러 서버는 메모리 공유가 안되기 때문에 DB를 통해서 락을 걸어두지 않으면 동시성 제어가 안되기 때문
  
2. 분산된 DB 리소스를 쓰는 방법<br/>
 - like Redis ..
   
4. 어플리케이션 메모리 레벨에서 처리<br/>
 - ConcurrentHashMap, Synchronized ..

5. 동시성 처리를 하지 않고 동시성 처리가 되는 것 <br/>
 - PK와 Unique

#### 2주차 회고
- 이번 특강 신청 로직에서 비관적 락을 사용한 이유는 요구사항이 30명 이었고, 선착순이기 때문에 확실한 제어가 필요하다고 생각해서 구현하게 되었다.
  - 하지만 트래픽이 많고 DB 리소스가 여유롭지 않은 대부분의 상황 + 성능 향상을 위해서는 낙관적 락이 유리함. <br/>(이번 특강 신청 로직에서도 특강 신청을 INSERT로만 하게 된다면 낙관적 락도 적합)
- 그동안 이론으로만 배우고 외웠던 하위참조, 추상화 의존, DB 변경 시에도 영향을 받지 않도록 구현하며 DIP와 OCP를 많이 생각하며 구현하게 됨
- 자세히 알지 못했던 DB 레벨에서의 낙관적 락, 비관적 락에 대해 공부하게 됐고, 다양한 동시성 이슈 해결에 고민하게 됨.
- Architecture
  - DB 변경 시에도 영향을 받지 않도록 추상화에 의존, 도메인 로직을 안전하고 순수하게 하기 위해 DIP와 OCP을 고려하며 구현 


### ERD
![hhplus_2st](https://github.com/corncode8/hhplus_tdd_2st/assets/127717982/391ef0b4-d54a-46b2-8f16-8677f91aeae0)
